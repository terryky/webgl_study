(()=>{"use strict";let e={load_file_sync:function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(null),t},compile_shader_text:function(e,t,r){const i=e.createShader(t);return e.shaderSource(i,r),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)?i:(alert("An error occurred compiling the shaders: "+e.getShaderInfoLog(i)),e.deleteShader(i),null)},compile_shader_file:function(t,r,i){const a=e.load_file_sync(i).responseText;return e.compile_shader_text(t,r,a)},link_shaders:function(e,t,r){const i=e.createProgram();return e.attachShader(i,t),e.attachShader(i,r),e.linkProgram(i),e.getProgramParameter(i,e.LINK_STATUS)||alert("Could not initialise shaders"),i},generate_shader:function(t,r,i){const a=e.compile_shader_text(t,t.VERTEX_SHADER,r),o=e.compile_shader_text(t,t.FRAGMENT_SHADER,i),n=e.link_shaders(t,a,o);return t.deleteShader(a),t.deleteShader(o),{program:n,loc_vtx:t.getAttribLocation(n,"a_Vertex"),loc_clr:t.getAttribLocation(n,"a_Color"),loc_nrm:t.getAttribLocation(n,"a_Normal"),loc_uv:t.getAttribLocation(n,"a_TexCoord"),loc_smp:t.getUniformLocation(n,"u_sampler")}}},t={create_texture:function(e){let t=e.createTexture();return e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),t},delete_texture:function(e,t){e.deleteTexture(t)},create_image_texture:function(e,r){let i=t.create_texture(e),a=new Image;return a.crossOrigin="Anonymous",a.onload=function(){e.bindTexture(e.TEXTURE_2D,i),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,a),e.generateMipmap(e.TEXTURE_2D)},a.src=r,i},create_image_texture_from_file:function(e,r){let i=t.create_texture(e),a=new Image,o=new FileReader;return a.onload=function(){e.bindTexture(e.TEXTURE_2D,i),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,a),e.generateMipmap(e.TEXTURE_2D)},o.onload=function(e){let t=e.target.result;a.src=t},o.readAsDataURL(r),i},create_video_texture:function(e,r){let i={ready:!1};i.texid=t.create_texture(e);let a=document.createElement("video");a.autoplay=!0,a.muted=!0,a.loop=!0;let o=!1,n=!1;function _(){o&&n&&(i.ready=!0)}return a.addEventListener("playing",(function(){o=!0,_()}),!0),a.addEventListener("timeupdate",(function(){n=!0,_()}),!0),a.src=r,a.play(),i.video=a,i},get_video_resolution:function(e){let t=0,r=0;return e.ready&&(t=e.video.videoWidth,r=e.video.videoHeight),{w:t,h:r}},is_video_ready:function(e){return e.ready},update_video_texture:function(e,t){t.ready&&(e.bindTexture(e.TEXTURE_2D,t.texid),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t.video))},create_camera_texture:function(e){let r={ready:!1};r.texid=t.create_texture(e);let i=document.createElement("video");return i.autoplay=!0,i.loop=!0,navigator.mediaDevices=navigator.mediaDevices||navigator.mozGetUserMedia,navigator.webkitGetUserMedia,navigator.mediaDevices?(navigator.mediaDevices.getUserMedia({audio:!1,video:{width:{ideal:640},height:{ideal:480}}}).then((function(e){i.onloadedmetadata=function(){r.ready=!0},i.srcObject=e,i.play()})).catch((function(e){return alert("failed to initialize a camera"),r})),r.video=i,r):(alert("not supported navigator.mediaDevices"),r)},get_camera_resolution:function(e){let t=0,r=0;return e.ready&&(t=e.video.videoWidth,r=e.video.videoHeight),{w:t,h:r}},is_camera_ready:function(e){return e.ready},update_camera_texture:function(e,t){t.ready&&(e.bindTexture(e.TEXTURE_2D,t.texid),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t.video))}},r=null;const i=[-.5,.5,-.5,-.5,.5,.5],a=[1,1,1,1,1,1,1,1,1,1,1,1],o=[0,0,0,1,1,0];class n{constructor(){this.gl=null,this.sobj=null,this.vao=null,this.texid=null,this.video=null}initialize(e){const t=document.querySelector("#glcanvas").getContext("webgl2");t?(t.clearColor(.5,.5,.5,1),this.gl=t):alert("Failed to initialize WebGL2.")}loadScene(){const r=this.gl,i=e.generate_shader(r,"#version 300 es\n    in  vec4 a_Vertex;\n    in  vec4 a_Color;\n    in  vec2 a_TexCoord;\n    out vec4 v_color;\n    out vec2 v_texcoord;\n    void main()\n    {\n        gl_Position = a_Vertex;\n        v_color     = a_Color;\n        v_texcoord  = a_TexCoord;\n    }\n","#version 300 es\n    precision mediump float;\n    in  vec4 v_color;\n    in  vec2 v_texcoord;\n    out vec4 o_color;\n    uniform sampler2D u_sampler;\n    void main()\n    {\n        o_color = v_color * texture(u_sampler, v_texcoord);\n    }\n"),a=this.init_vbos(r),o=this.init_vaos(r,i,a),n=t.create_image_texture(r,"../../assets/webgl.png"),_=t.create_video_texture(r,"../../assets/BigBuckBunny_640x360.mp4");this.sobj=i,this.vao=o,this.texid=n,this.video=_}init_vbos(e){const t=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,t),e.bufferData(e.ARRAY_BUFFER,new Float32Array(i),e.STATIC_DRAW);const r=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,new Float32Array(a),e.STATIC_DRAW);const n=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,new Float32Array(o),e.STATIC_DRAW),{vbo_vtx:t,vbo_col:r,vbo_uv:n}}init_vaos(e,t,r){const i=e.createVertexArray();return e.bindVertexArray(i),e.bindBuffer(e.ARRAY_BUFFER,r.vbo_vtx),e.enableVertexAttribArray(t.loc_vtx),e.vertexAttribPointer(t.loc_vtx,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,r.vbo_col),e.enableVertexAttribArray(t.loc_clr),e.vertexAttribPointer(t.loc_clr,4,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,r.vbo_uv),e.enableVertexAttribArray(t.loc_uv),e.vertexAttribPointer(t.loc_uv,2,e.FLOAT,!1,0,0),i}renderMain(e){let r=this.gl,i=this.sobj,a=this.vao,o=this.texid;r.clear(r.COLOR_BUFFER_BIT),r.useProgram(i.program),r.activeTexture(r.TEXTURE0),this.video.ready?(t.update_video_texture(r,this.video),r.bindTexture(r.TEXTURE_2D,this.video.texid)):r.bindTexture(r.TEXTURE_2D,o),r.uniform1i(i.loc_smp,0),r.bindVertexArray(a),r.drawArrays(r.TRIANGLE_STRIP,0,3),requestAnimationFrame((e=>this.renderMain(e)))}runMainLoop(){requestAnimationFrame((e=>this.renderMain(e)))}}window.startWebGL=function(e){try{r=new n,r.initialize(e),r.loadScene(),r.runMainLoop()}catch(e){alert(`エラーが発生しました。\n${e.message}(${e.stack})`)}}})();