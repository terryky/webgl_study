(()=>{"use strict";let e={load_file_sync:function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(null),t},compile_shader_text:function(e,t,r){const a=e.createShader(t);return e.shaderSource(a,r),e.compileShader(a),e.getShaderParameter(a,e.COMPILE_STATUS)?a:(alert("An error occurred compiling the shaders: "+e.getShaderInfoLog(a)),e.deleteShader(a),null)},compile_shader_file:function(t,r,a){const i=e.load_file_sync(a).responseText;return e.compile_shader_text(t,r,i)},link_shaders:function(e,t,r){const a=e.createProgram();return e.attachShader(a,t),e.attachShader(a,r),e.linkProgram(a),e.getProgramParameter(a,e.LINK_STATUS)||alert("Could not initialise shaders"),a},generate_shader:function(t,r,a){const i=e.compile_shader_text(t,t.VERTEX_SHADER,r),n=e.compile_shader_text(t,t.FRAGMENT_SHADER,a),o=e.link_shaders(t,i,n);return t.deleteShader(i),t.deleteShader(n),{program:o,loc_vtx:t.getAttribLocation(o,"a_Vertex"),loc_clr:t.getAttribLocation(o,"a_Color"),loc_nrm:t.getAttribLocation(o,"a_Normal"),loc_uv:t.getAttribLocation(o,"a_TexCoord"),loc_smp:t.getUniformLocation(o,"u_sampler")}}},t={create_texture:function(e){let t=e.createTexture();return e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),t},delete_texture:function(e,t){e.deleteTexture(t)},create_image_texture:function(e,r){let a=t.create_texture(e),i=new Image;return i.crossOrigin="Anonymous",i.onload=function(){e.bindTexture(e.TEXTURE_2D,a),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i),e.generateMipmap(e.TEXTURE_2D)},i.src=r,a},create_image_texture_from_file:function(e,r){let a=t.create_texture(e),i=new Image,n=new FileReader;return i.onload=function(){e.bindTexture(e.TEXTURE_2D,a),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i),e.generateMipmap(e.TEXTURE_2D)},n.onload=function(e){let t=e.target.result;i.src=t},n.readAsDataURL(r),a},create_video_texture:function(e,r){let a={ready:!1};a.texid=t.create_texture(e);let i=document.createElement("video");i.autoplay=!0,i.muted=!0,i.loop=!0;let n=!1,o=!1;function _(){n&&o&&(a.ready=!0)}return i.addEventListener("playing",(function(){n=!0,_()}),!0),i.addEventListener("timeupdate",(function(){o=!0,_()}),!0),i.src=r,i.play(),a.video=i,a},get_video_resolution:function(e){let t=0,r=0;return e.ready&&(t=e.video.videoWidth,r=e.video.videoHeight),{w:t,h:r}},is_video_ready:function(e){return e.ready},update_video_texture:function(e,t){t.ready&&(e.bindTexture(e.TEXTURE_2D,t.texid),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t.video))},create_camera_texture:function(e){let r={ready:!1};r.texid=t.create_texture(e);let a=document.createElement("video");return a.autoplay=!0,a.loop=!0,navigator.mediaDevices=navigator.mediaDevices||navigator.mozGetUserMedia,navigator.webkitGetUserMedia,navigator.mediaDevices?(navigator.mediaDevices.getUserMedia({audio:!1,video:{width:{ideal:640},height:{ideal:480}}}).then((function(e){a.onloadedmetadata=function(){r.ready=!0},a.srcObject=e,a.play()})).catch((function(e){return alert("failed to initialize a camera"),r})),r.video=a,r):(alert("not supported navigator.mediaDevices"),r)},get_camera_resolution:function(e){let t=0,r=0;return e.ready&&(t=e.video.videoWidth,r=e.video.videoHeight),{w:t,h:r}},is_camera_ready:function(e){return e.ready},update_camera_texture:function(e,t){t.ready&&(e.bindTexture(e.TEXTURE_2D,t.texid),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t.video))}},r=null;const a=[-.5,.5,-.5,-.5,.5,.5],i=[1,1,1,1,1,1,1,1,1,1,1,1],n=[0,0,0,1,1,0];class o{constructor(){this.gl=null,this.sobj=null,this.vao=null,this.texid=null}initialize(e){const t=document.querySelector("#glcanvas").getContext("webgl2");t?(t.clearColor(.5,.5,.5,1),this.gl=t):alert("Failed to initialize WebGL2.")}loadScene(){const r=this.gl,a=e.generate_shader(r,"#version 300 es\n    in  vec4 a_Vertex;\n    in  vec4 a_Color;\n    in  vec2 a_TexCoord;\n    out vec4 v_color;\n    out vec2 v_texcoord;\n    void main()\n    {\n        gl_Position = a_Vertex;\n        v_color     = a_Color;\n        v_texcoord  = a_TexCoord;\n    }\n","#version 300 es\n    precision mediump float;\n    in  vec4 v_color;\n    in  vec2 v_texcoord;\n    out vec4 o_color;\n    uniform sampler2D u_sampler;\n    void main()\n    {\n        o_color = v_color * texture(u_sampler, v_texcoord);\n    }\n"),i=this.init_vbos(r),n=this.init_vaos(r,a,i),o=t.create_image_texture(r,"../../assets/webgl.png");this.sobj=a,this.vao=n,this.texid=o}init_vbos(e){const t=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,t),e.bufferData(e.ARRAY_BUFFER,new Float32Array(a),e.STATIC_DRAW);const r=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,new Float32Array(i),e.STATIC_DRAW);const o=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,o),e.bufferData(e.ARRAY_BUFFER,new Float32Array(n),e.STATIC_DRAW),{vbo_vtx:t,vbo_col:r,vbo_uv:o}}init_vaos(e,t,r){const a=e.createVertexArray();return e.bindVertexArray(a),e.bindBuffer(e.ARRAY_BUFFER,r.vbo_vtx),e.enableVertexAttribArray(t.loc_vtx),e.vertexAttribPointer(t.loc_vtx,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,r.vbo_col),e.enableVertexAttribArray(t.loc_clr),e.vertexAttribPointer(t.loc_clr,4,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,r.vbo_uv),e.enableVertexAttribArray(t.loc_uv),e.vertexAttribPointer(t.loc_uv,2,e.FLOAT,!1,0,0),a}renderMain(e){let t=this.gl,r=this.sobj,a=this.vao,i=this.texid;t.clear(t.COLOR_BUFFER_BIT),t.useProgram(r.program),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,i),t.uniform1i(r.loc_smp,0),t.bindVertexArray(a),t.drawArrays(t.TRIANGLE_STRIP,0,3),requestAnimationFrame((e=>this.renderMain(e)))}runMainLoop(){requestAnimationFrame((e=>this.renderMain(e)))}}window.startWebGL=function(e){try{r=new o,r.initialize(e),r.loadScene(),r.runMainLoop()}catch(e){alert(`エラーが発生しました。\n${e.message}(${e.stack})`)}}})();